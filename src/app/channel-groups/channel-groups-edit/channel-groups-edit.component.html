<div id="title">
  <h1>
    {{editMode ? "Edit Channel Group" : "Create Channel Group"}}
  </h1>
  
  <div id="save-cancel-cg" class="btn-container-right">
    <button mat-flat-button color="primary" (click)="formUnsaved()"
      >Cancel</button>
    <button mat-flat-button color="accent" (click)="save()" [disabled]="selectedChannels?.length === 0"
      >Save Group</button>
  </div>
</div>

<div id="edit-container" class="square-box">
  <div id="selection-container">
    <div id="selection-filter" class="square-box">
      <div id="filter-container">
        <h3 class="help-text">Search for channels:</h3>
        <app-channel-groups-filter (filtersChanged)="getChannelsWithFilters($event)"> 
        </app-channel-groups-filter>
      </div>
      <div id="add-undo-container" class="btn-container-right">
        <button mat-flat-button color="accent" (click)="addChannelsToSelected()" 
          [disabled]="!availableChannels || availableChannels.length === 0">
          Add Channels
        </button>
        <button mat-flat-button color="warn" (click)="undoSelectRemove()" 
          [disabled]="!changeMade">
          Undo Last
        </button>
      </div>
    </div>

    <div id="list-and-map-container">
      <div id="preview-list" class="square-box">
        <h4>Selection Preview</h4>
        <!-- <app-loading *ngIf="loading"></app-loading> -->
        <div class="table-container" *ngIf="!loading; else isLoading">
          <ngx-datatable 
            #availableTable
            id="channel-selector"
            class="material" 
            [rows]="availableChannels" 
            [columnMode]="ColumnMode.force"
            [headerHeight]="50" 
            [footerHeight]="50" 
            [rowHeight]="50"
            [scrollbarV]="true"
            rowHeight="auto" 
            [limit]="9" 
            [sortType]="SortType.multi"
            >
            <ngx-datatable-column name="Network" [draggable]="false" [sortable]="true" [resizeable]="false" [width]="100">
              <ng-template let-row="row" ngx-datatable-cell-template>
                {{ row.networkCode | uppercase }}
              </ng-template>
            </ngx-datatable-column>
            <ngx-datatable-column name="Station" [draggable]="false" [sortable]="true" [resizeable]="false" [width]="100">
              <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
                {{ row.stationCode | uppercase }}
              </ng-template>
            </ngx-datatable-column>
            <ngx-datatable-column name="Location" [draggable]="false" [sortable]="true" [resizeable]="false" [width]="100">
              <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
                {{row.loc}}
              </ng-template>
            </ngx-datatable-column>
            <ngx-datatable-column name="Channel" [draggable]="false" [sortable]="true" [resizeable]="false" [width]="100">
              <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
                {{ row.code | uppercase }}
              </ng-template>
            </ngx-datatable-column>
          </ngx-datatable>
        </div>
        <ng-template #isLoading>
          <mat-spinner></mat-spinner>
        </ng-template>
      </div>
  
      <div id="map-box">
        <app-map [selectedChannels]="selectedChannels"
          [searchChannels]="searchChannels"
          [removeChannels]="filteredChannels"
          [isRemoving]="isSelectedFiltered"
          [editPage]=true
          (boundsChange)="updateBounds($event)"
        ></app-map>
      </div>
    </div>
  </div>

  <div id="selected-channels" class="square-box">
    <form class="" [formGroup]="channelGroupForm">
      <mat-form-field class="channel-group-input">
        <input matInput placeholder="Channel Group Name" formControlName="name">
      </mat-form-field>
      <mat-form-field class="channel-group-input">
        <textarea matInput placeholder="Channel Group Description" formControlName="description"></textarea>
      </mat-form-field>
      <mat-expansion-panel
        (opened)="onFilteringOpen()"
        (closed)="onFilteringClose()"
        (keydown.enter)="$event.preventDefault()"
      >
        <mat-expansion-panel-header>
          <mat-panel-title>
            Filter Selected Channels
          </mat-panel-title>
          <mat-panel-description>
            <button mat-flat-button
              color="warn"
              (click)="removeChannels()"
              [disabled]="!isSelectedFiltered"
            >Remove Channels</button>
          </mat-panel-description>
        </mat-expansion-panel-header>
        <app-channel-groups-filter #selectedFilter (filtersChanged)="onSelectedFilter($event)"> 
        </app-channel-groups-filter>  
      </mat-expansion-panel>

      <h3>Selected Channels</h3>
      <p class="help-text">These channels will appear on your widget.</p>
      <ngx-datatable 
        #selectedTable
        id="group-channels"
        class="material" 
        [rows]="filteredChannels"
        [columnMode]="ColumnMode.force"
        [headerHeight]="50"
        [footerHeight]="50" 
        [rowHeight]="50"
        [scrollbarV]="true"
        rowHeight="auto" 
        [selected]="filteredChannels"
        [selectionType]="SelectionType.checkbox" 
        (select)="onSelect($event)"
      >
        <ngx-datatable-column [width]="50" [sortable]="false" [canAutoResize]="false" [draggable]="false"
        [resizeable]="false">
          <ng-template ngx-datatable-header-template let-value="value">
          </ng-template>
          <ng-template ngx-datatable-cell-template let-value="value" let-row="row">
            <button (click)="removeChannel(row)">X</button>
          </ng-template>
        </ngx-datatable-column>
        <ngx-datatable-column name="Network" [draggable]="false" [sortable]="false" [resizeable]="false" [width]="100">
          <ng-template let-row="row" ngx-datatable-cell-template>
            {{ row.networkCode | uppercase }}
          </ng-template>
        </ngx-datatable-column>
        <ngx-datatable-column name="Station" [draggable]="false" [sortable]="false" [resizeable]="false" [width]="100">
          <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
            {{ row.stationCode | uppercase }}
          </ng-template>
        </ngx-datatable-column>
        <ngx-datatable-column name="Location" [draggable]="false" [sortable]="true" [resizeable]="false" [width]="100">
            <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
              {{row.loc}}
            </ng-template>
          </ngx-datatable-column>
        <ngx-datatable-column name="Channel" [draggable]="false" [sortable]="false" [resizeable]="false" [width]="100">
          <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
            {{ row.code | uppercase }}
          </ng-template>
        </ngx-datatable-column>
      </ngx-datatable>
    </form>
  </div>
</div>

<div id="channel-group-popup" class="popup">
  <div id="channel-group-popup-box" class="box popup-box">
    <p>
      Your new channel group will not be saved.<br/>
      Would you like to continue?
    </p>
    <div class="btn-container">
      <button mat-flat-button color="primary" 
        (click)="closePopup()"
      >Cancel</button>
      <button mat-flat-button color="accent"
        (click)="cancel()"  
      >Continue</button>
    </div>
  </div>
</div>